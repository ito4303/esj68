---
title: R, BUGS, Stanによる階層モデルのあてはめ
author: "伊東宏樹"
date: "2021-03-21"
output:
  beamer_presentation:
    latex_engine: lualatex
    theme: metropolis
    keep_tex: true
    includes:
      in_header: header.tex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(AHMbook)
library(unmarked)
library(rjags)
library(cmdstanr)
options(mc.cores = parallel::detectCores())
```

## 本日の発表内容

- **サイト占有モデル**
    - 模擬データの作成
    - unmarked, JAGS, Stanによる当てはめ
- ***N*** **混合モデル**
    - 模擬データの作成
    - unmarked, JAGS, Stanによる当てはめ

## 本日のコード

本日のコードは以下の場所に置いてあります。

https://github.com/ito4303/esj68


# サイト占有モデル

## 模擬データの生成

```{r set_seed, include=FALSE}
set.seed(123)
```


```{r gen_site_occ_data, echo=TRUE}
occ_data <- AHMbook::simOcc(
  M = 300,                # Number of sites
  J = 2,                  # Number of temporal replicates
  mean.occupancy = 0.6,   # Mean occurrence
  beta1 = -2,             # Main effect of elev. on occ.
  beta2 = 2,              # Main effect of forest on occ.
  beta3 = 0,              # Interaction of elev. and forest
  mean.detection = 0.3,   # Mean detection prob.
  time.effects = c(0, 0), # Time effect
  alpha1 = 0,             # Main effect of elev. on det.
  alpha2 = -3,            # Main effect of wind speed on det.
  alpha3 = 0,             # Interaction on det. of elev and wind
  sd.lp = 0.5,            # S.D. of random site effects
  b = 0,                  # Behavioral response
  show.plot = FALSE)
```


## データの確認

真の占有サイト数

```{r view_site_occ_data1, echo=TRUE}
sum(occ_data$z)
```

観測された占有サイト数

```{r view_site_occ_data2, echo=TRUE}
sum(apply(occ_data$y, 1, max))
```

## データの確認

最初の6サイトの真値と観測値

```{r view_site_occ_data3, echo=TRUE}
head(cbind(z = occ_data$z, occ_data$y))
```

## plot

\includegraphics[width=11cm]{occ_data-1.pdf}

## plot

\includegraphics[width=11cm]{occ_data-2.pdf}

# unmarkedによる占有モデルの当てはめ

## unmarkedオブジェクトの作成

```{r occ_unmarked, echo=TRUE, message=FALSE}
umf <- unmarkedFrameOccu(
  y = occ_data$y,
  siteCovs = data.frame(elev = occ_data$elev,
                        forest = occ_data$forest),
  obsCovs = list(wind = occ_data$wind))
```

## unmarkedオブジェクト

```{r occ_unmarked_summary, echo=TRUE}
summary(umf)
```


## あてはめ（切片だけのモデル）

```{r occ_unmarked_fit, echo=TRUE}
(fm0 <- occu(~ 1  ~ 1, data = umf))
```


## あてはめ（共変量のあるモデル）

```{r occ_unmarked_fit2, echo=TRUE}
(fm1 <- occu(~ wind ~ elev + forest, data = umf))
```

<!--
```{r, echo=TRUE}
#backTransform(fm0, "state")
```
-->

<!--
```{r, echo=TRUE}
#backTransform(fm0, "det")
```
-->


## モデル選択

```{r}
fms <- fitList('psi(.)p(.)' = fm0, 'psi(Wind)p(Elev+Forest)' = fm1)
modSel(fms)
```


# JAGSによる占有モデルの当てはめ

## JAGSモデル

```{r, message=FALSE}
model_file <- "occ.txt"
s <- scan(model_file, what = character(), sep = "\n")
cat(s, sep = "\n")
```


## 結果

```{r occ_jags, include=FALSE}
set.seed(1)
jags_data <- list(M = occ_data$M, J = occ_data$J, y = occ_data$y,
                  elev = occ_data$elev, forest = occ_data$forest,
                  wind = occ_data$wind)
ini_fun <- function() {
  list(beta = rnorm(3, 0, 2),
       alpha = rnorm(2, 0, 2),
       z = rep(1, occ_data$M))
}
rdata_file <- "occ_jags.RData"
if (file.exists(rdata_file) &
    (file.mtime(rdata_file) > file.mtime(model_file))) {
  load(rdata_file)
} else {
  mod_occ_jags <- jags.model(model_file, data = jags_data,
                             inits = ini_fun, n.chains = 3)
  update(mod_occ_jags, 1000)
  fit_occ_jags <- coda.samples(mod_occ_jags, n.iter = 1000,
                               variable.names = c("beta", "alpha", "z"))
  save(fit_occ_jags, file = rdata_file)
}
```

```{r occ_jags_summary, echo=TRUE}
summary(fit_occ_jags)$statistics[1:5, ]
```


# Stanによる占有モデルのあてはめ

## Stanモデル

```{r, message=FALSE}
model_file <- "occ.stan"
s <- scan(model_file, what = character(), sep = "\n")
cat(s[1:13], sep = "\n")
```

---

```{r}
cat(s[14:24], sep = "\n")
```

---

```{r}
cat(s[25:40], sep = "\n")
```

## 結果

```{r occ_stan, include=FALSE}
output_file <- "occ_stan.RDS"
if (file.exists(output_file) &
    file.mtime(output_file) > file.mtime(model_file)) {
  fit_occ_stan <- readRDS(output_file)
} else {
  stan_data <- list(M = occ_data$M, J = occ_data$J, Y = occ_data$y,
                    Elev = occ_data$elev, Forest = occ_data$forest,
                    Wind = occ_data$wind)
  mod_occ_stan <- cmdstan_model(model_file)
  fit_occ_stan <- mod_occ_stan$sample(data = stan_data, seed = 1,
                                      chains = 4, parallel_chains = 4,
                                      iter_sampling = 1000,
                                      iter_warmup = 1000,
                                    refresh = 500)
  fit_occ_stan$save_object(output_file)
}
```

```{r occ_stan_summary, echo=TRUE}
fit_occ_stan$print(c("beta", "alpha"))
```


# *N*混合モデル

## 模擬データ

```{r, include=FALSE}
set.seed(123)
```

```{r nmix_data, echo=TRUE, message=FALSE}
nmix_data <- AHMbook::simNmix(
  nsites = 120,         # Number of sites
  nvisits = 2,          # Number of visits pre site
  mean.lam = 2,         # Expected abundance
  mean.p = 0.6,         # Expected detection
  beta2.lam = 0.5,      # Coef. of site covariate 2
                        # in abundance model
  beta.p.survey = 0.8,  # Coef. of survey covariate on p
  show.plots = FALSE)
```


# unmarkedによる*N*混合モデルの当てはめ

## unmarkedオブジェクトの作成

```{r nmix_unmarked, echo=TRUE}
umf <- unmarkedFramePCount(
  y = nmix_data$C,
  siteCovs = data.frame(site_cov =
                          nmix_data$site.cov[, 2]),
  obsCovs = list(survey_cov = nmix_data$survey.cov))
```

## unmarkedオブジェクト

```{r nmix_unmarked_summary, echo=TRUE}
summary(umf)
```


## あてはめ

```{r nmix_unmarked_fit, echo=TRUE}
fm2 <- pcount( ~ survey_cov ~ site_cov, data = umf, K = 110)
print(fm2)
```


# JAGSによる*N*混合モデルの当てはめ

## JAGS

```{r, message=FALSE}
model_file <- "nmix.txt"
s <- scan(model_file, what = character(), sep = "\n")
cat(s, sep = "\n")
```


## 結果

```{r nmix_jags, include=FALSE}
set.seed(1)
jags_data <- list(M = nmix_data$nsites, J = nmix_data$nvisits,
                  y = nmix_data$C,
                  cov.abn = nmix_data$site.cov[, 2],
                  cov.det = nmix_data$survey.cov)
ini_fun <- function() {
  list(beta = rnorm(2, 0, 2),
       alpha = rnorm(2, 0, 2),
       n = apply(nmix_data$C, 1, max))
}
rdata_file <- "nmix_jags.RData"
if (file.exists(rdata_file) &
    (file.mtime(rdata_file) > file.mtime(model_file))) {
  load(rdata_file)
} else {
  mod_nmix_jags <- jags.model(model_file, data = jags_data,
                              inits = ini_fun, n.chains = 3)
  update(mod_nmix_jags, 1000)
  fit_nmix_jags <- coda.samples(mod_nmix_jags, n.iter = 2000,
                                variable.names = c("beta", "alpha", "n"))
  save(fit_nmix_jags, file = rdata_file)
}
```

```{r, echo=TRUE}
print(summary(fit_nmix_jags)$statistics[1:4, ])
```


# Stanによる*N*混合モデルの当てはめ

## Stan

```{r, message=FALSE}
model_file <- "nmix.stan"
s <- scan(model_file, what = character(), sep = "\n")
cat(s[1:8], sep = "\n")
```

---

```{r}
cat(s[9:12], sep = "\n")
```

---

```{r}
cat(s[13:25], sep = "\n")
```

---

```{r}
cat(s[26:32], sep = "\n")
```

---

```{r}
cat(s[33:37], sep = "\n")
```

## 結果

```{r nmix_stan_1, include=FALSE}
output_file <- "nmix_stan1.RDS"
stan_data <- list(M = nmix_data$nsites, J = nmix_data$nvisits,
                  Y = nmix_data$C,
                  Cov_abn = nmix_data$site.cov[, 2],
                  Cov_det = nmix_data$survey.cov,
                  Max_N = max(nmix_data$C) + 100)
if (file.exists(output_file) &
    file.mtime(output_file) > file.mtime(model_file)) {
  fit_nmix_stan_1 <- readRDS(output_file)
} else {
  mod_nmix_stan_1 <- cmdstan_model(model_file)
  fit_nmix_stan_1 <- mod_nmix_stan_1$sample(
    data = stan_data, seed = 1,
    chains = 4, parallel_chains = 4,
    iter_sampling = 1000,
    iter_warmup = 1000,
    refresh = 500)
  fit_nmix_stan_1$save_object(output_file)
}
```

```{r nmix1_stan_summary, echo=TRUE}
fit_nmix_stan_1$print(c("beta", "alpha"))
```

## Reduce Sum による並列化


```{r, message=FALSE}
model_file <- "nmix_rs.stan"
s <- scan(model_file, what = character(), sep = "\n")
cat(s[c(1, 12:22)], sep = "\n")
```

---

```{r}
cat(s[23:33], sep = "\n")
```

---

```{r}
cat(s[34:45], sep = "\n")
```

---

```{r}
cat(s[67:73], sep = "\n")
```

---

```{r nmix_stan_2, include=FALSE}
output_file <- "nmix_stan2.RDS"
if (file.exists(output_file) &
    (file.mtime(output_file) > file.mtime(model_file))) {
  fit_nmix_stan_2 <- readRDS(output_file)
} else {
  mod_nmix_stan_2 <- cmdstan_model(model_file,
                                   cpp_options = list(stan_threads = TRUE))
  fit_nmix_stan_2 <- mod_nmix_stan_2$sample(
    data = stan_data, seed = 1,
    chains = 4, parallel_chains = 4,
    threads_per_chain = 3,
    iter_sampling = 1000,
    iter_warmup = 1000,
    refresh = 500)
  fit_nmix_stan_2$save_object(output_file)
}
```

## 結果

```{r nmix_stan_2_summary, echo=TRUE}
fit_nmix_stan_2$summary(c("beta", "alpha"))
```

## 二変量ポアソン分布を使用したモデル化

```{r, message=FALSE}
model_file <- "nmix_bp.stan"
s <- scan(model_file, what = character(), sep = "\n")
cat(s[c(1, 19:33)], sep = "\n")
```

---

```{r}
cat(s[62:67], sep = "\n")
```

## 結果

```{r nmix_stan_3, include=FALSE}
output_file <- "nmix_stan3.RDS"
if (file.exists(output_file) &
    file.mtime(output_file) > file.mtime(model_file)) {
  fit_nmix_stan_3 <- readRDS(output_file)
} else {
  mod_nmix_stan_3 <- cmdstan_model(model_file)
  fit_nmix_stan_3 <- mod_nmix_stan_3$sample(
    data = stan_data, seed = 1,
    chains = 4, parallel_chains = 4,
    iter_sampling = 1000,
    iter_warmup = 1000,
    refresh = 500)
  fit_nmix_stan_3$save_object(output_file)
}
```


```{r nmix_stan_3_summary, echo=TRUE}
fit_nmix_stan_3$summary(c("beta", "alpha"))
```

## まとめ

- unmarked, JAGS, Stan のそれぞれで、サイト占有モデルや$N$混合モデルのあてはめができる。
- モデル構造が比較的単純なら、unmarkedが簡単。
- モデルが複雑になると、JAGSやStanによるモデルの記述が必要になるかもしれない。
- Stanでは、離散パラメータを扱えないが、周辺化消去したり、アルゴリズムを工夫することで、サイト占有モデルや、$N$混合モデルを扱える。
    - ただし、モデルの記述が直感的ではなくなる場合もある。


