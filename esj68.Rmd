---
title: "R, BUGS, Stanによる階層モデルのあてはめ"
author: "伊東宏樹"
date: "12/8/2020"
output:
  beamer_presentation:
    latex_engine: lualatex
    theme: metropolis
    keep_tex: false
    includes:
      in_header: header.tex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(unmarked)
library(rjags)
library(cmdstanr)
options(mc.cores = parallel::detectCores())
```


## 目次

\tableofcontents[hideallsubsections]

# 占有モデル

## 模擬データの生成

```{r gen_site_occ_data, echo=TRUE}
set.seed(123)
M <- 100      # Number of sites
J <- 2        # Number of presence/absence meas.
y <- matrix(NA, nrow = M, ncol = J)
psi <- 0.8    # Prob. occupancy or presence
p <- 0.5      # Prob. detection
z <- rbinom(n = M, size = 1, prob = psi)
for(j in 1:J) {
   y[, j] <- rbinom(n = M, size = 1, prob = z * p)
}
```


## True number of occupied sites

```{r view_site_occ_data1, echo=TRUE}
sum(z)
```

## Observed number of occupied sites

```{r view_site_occ_data2, echo=TRUE}
sum(apply(y, 1, max))
```

## Truth and measurements for first 6

```{r view_site_occ_data3, echo=TRUE}
head(cbind(z = z, y))
```

## unmarked

```{r, echo=TRUE}
umf <- unmarkedFrameOccu(y = y)
summary(umf)
```

##  あてはめ

```{r, echo=TRUE}
fm1 <- occu(~ 1 ~ 1, data = umf)
```

## 結果

```{r, echo=TRUE}
print(fm1)
```

## 占有確率

```{r, echo=TRUE}
backTransform(fm1, "state")
```

## 検出確率

```{r, echo=TRUE}
backTransform(fm1, "det")
```

## JAGS

```
model {
  for (m in 1:M) {
    z[m] ~ dbern(psi)
    for (j in 1:J) {
      y[m, j] ~ dbern(z[m] * p)
    }
  }
  # priors
  psi ~ dunif(0, 1)
  p ~ dunif(0, 1)
}
```

## Fit

```{r, include=FALSE}
set.seed(1)
jags_data <- list(M = M, J = J, y = y)
ini_fun <- function() {
  list(psi = runif(1, 0, 1),
       p = runif(1, 0, 1),
       z = rep(1, M))
}
model1j <- jags.model("occ1.txt", data = jags_data,
                     inits = ini_fun, n.chains = 3)
update(model1j, 1000)
fit1j <- coda.samples(model1j, n.iter = 1000,
                      variable.names = c("psi", "p"))
```

```{r}
summary(fit1j)
```


## Stan

```{r, include=FALSE}
stan_data <- list(M = M, J = J, Y = y)
model1s <- cmdstanr::cmdstan_model("occ1.stan")
fit1s <- model1s$sample(data = stan_data, seed = 1,
                        chains = 4, parallel_chains = 4,
                        num_samples = 1000, num_warmup = 1000)
```

```{r}
fit1s$summary(c("psi", "p"))
```



# N-混合モデル


