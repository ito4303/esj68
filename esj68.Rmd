---
title: "R, BUGS, Stanによる階層モデルのあてはめ"
author: "伊東宏樹"
date: "12/8/2020"
output:
  beamer_presentation:
    latex_engine: lualatex
    theme: metropolis
    keep_tex: false
    includes:
      in_header: header.tex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(unmarked)
library(rjags)
library(cmdstanr)
options(mc.cores = parallel::detectCores())
```


## 目次

\tableofcontents[hideallsubsections]

# 占有モデル

## 模擬データの生成

```{r gen_site_occ_data, echo=TRUE}
set.seed(24)                  # So we all get same data set
M <- 100                      # Number of sites
J <- 2                        # Number of presence/absence measurements
y <- matrix(NA, nrow = M, ncol = J) # to contain the obs. data

# Parameter values
psi <- 0.8                    # Probability of occupancy or presence
p <- 0.5                      # Probability of detection

# Generate presence/absence data (the truth)
z <- rbinom(n = M, size = 1, prob = psi)  # R has no Bernoulli

# Generate detection/nondetection data (i.e. presence/absence measurements)
for(j in 1:J){
   y[,j] <- rbinom(n = M, size = 1, prob = z*p)
}
```


## データ

```{r view_site_occ_data1, echo=TRUE}
sum(z)                        # True number of occupied sites
```

```{r view_site_occ_data2, echo=TRUE}
sum(apply(y, 1, max))         # Observed number of occupied sites
```

```{r view_site_occ_data3, echo=TRUE}
head(cbind(z=z, y))           # Truth and measurements for first 6 sites
```

## unmarked

```{r}
umf <- unmarkedFrameOccu(y = y)
summary(umf)
```

##  あてはめ

```{r}
fm1 <- occu(~ 1 ~ 1, data = umf)
```

## 結果

```{r}
print(fm1)
```

---

```{r}
backTransform(fm1, "state")
```

---

```{r}
backTransform(fm1, "det")
```

## JAGS

```
model {
  for (m in 1:M) {
    z[m] ~ dbern(psi)
    for (j in 1:J) {
      y[m, j] ~ dbern(z[m] * p)
    }
  }
  # priors
  psi ~ dunif(0, 1)
  p ~ dunif(0, 1)
}
```

## Fit



## Stan


# N-混合モデル


