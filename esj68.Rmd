---
title: "R, BUGS, Stanによる階層モデルのあてはめ"
author: "伊東宏樹"
date: "12/8/2020"
output:
  beamer_presentation:
    latex_engine: lualatex
    theme: metropolis
    keep_tex: false
    includes:
      in_header: header.tex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(AHMbook)
library(unmarked)
library(rjags)
library(cmdstanr)
options(mc.cores = parallel::detectCores())
```


## 目次

\tableofcontents[hideallsubsections]

# 占有モデル

## 模擬データの生成

```{r gen_site_occ_data, echo=TRUE}
set.seed(123)
occ_data <- simOcc(M = 300,
                   J = 2,
                   mean.occupancy = 0.6,
                   beta1 = -2,
                   beta2 = 2,
                   beta3 = 0,
                   mean.detection = 0.3,
                   time.effects = c(0, 0),
                   alpha1 = 0,
                   alpha2 = -3,
                   alpha3 = 0,
                   sd.lp = 0.5,
                   b = 0,
                    show.plot = FALSE)
```


## True number of occupied sites

```{r view_site_occ_data1, echo=TRUE}
sum(occ_data$z)
```

## Observed number of occupied sites

```{r view_site_occ_data2, echo=TRUE}
sum(apply(occ_data$y, 1, max))
```

## Truth and measurements for first 6

```{r view_site_occ_data3, echo=TRUE}
head(cbind(z = occ_data$z, occ_data$y))
```

## unmarked

```{r occ_unmarked, echo=TRUE}
umf <- unmarkedFrameOccu(y = occ_data$y,
                         siteCovs = data.frame(elev = occ_data$elev,
                                               forest = occ_data$forest),
                         obsCovs = list(wind = occ_data$wind))
summary(umf)
```

##  あてはめ

```{r occ_unmarked_fit, echo=TRUE}
fit_occ_unmarked <- occu(~ wind ~ elev + forest, data = umf)
```

## 結果

```{r occ_unmarked_results, echo=TRUE}
print(fit_occ_unmarked)
```

<!--




---

```{r, echo=TRUE}
backTransform(fm1, "state")
```

---

```{r, echo=TRUE}
backTransform(fm1, "det")
```
-->

## JAGS

```
model {
  for (m in 1:M) {
    z[m] ~ dbern(psi)
    for (j in 1:J) {
      y[m, j] ~ dbern(z[m] * p)
    }
  }
  # priors
  psi ~ dunif(0, 1)
  p ~ dunif(0, 1)
}
```

## Fit

```{r occ_jags, cache=TRUE}
set.seed(1)
jags_data <- list(M = occ_data$M, J = occ_data$J, y = occ_data$y,
                  elev = occ_data$elev, forest = occ_data$forest,
                  wind = occ_data$wind)
ini_fun <- function() {
  list(beta = rnorm(3, 0, 2),
       alpha = rnorm(2, 0, 2),
       z = rep(1, occ_data$M))
}
mod_occ_jags <- jags.model("occ.txt", data = jags_data,
                           inits = ini_fun, n.chains = 3)
update(mod_occ_jags, 1000)
fit_occ_jags <- coda.samples(mod_occ_jags, n.iter = 1000,
                             variable.names = c("beta", "alpha"))
```

```{r}
summary(mod_occ_jags)
```



## Stan

```{r occ_stan, cache=TRUE}
stan_data <- list(M = occ_data$M, J = occ_data$J, Y = occ_data$y,
                  Elev = occ_data$elev, Forest = occ_data$forest,
                  Wind = occ_data$wind)
mod_occ_stan <- cmdstan_model("occ.stan")
fit_occ_stan <- mod_occ_stan$sample(data = stan_data, seed = 1,
                                    chains = 4, parallel_chains = 4,
                                    iter_sampling = 1000,
                                    iter_warmup = 1000,
                                    refresh = 500)
```


```{r}
fit_occ_stan$summary(c("beta", "alpha"))
```



# N-混合モデル

## データ

```{r}
set.seed(123)
nmix_data <- simNmix(nsites = 120,
                     nvisits = 2,
                     mean.lam = 2,
                     mean.p = 0.6,
                     beta2.lam = 0.5,
                     beta.p.survey = 0.8,
                     show.plots = FALSE)
```



## unmarked

```{r nmix_unmarked}
umf <- unmarkedFramePCount(y = nmix_data$C,
                           siteCovs = data.frame(site_cov = nmix_data$site.cov[, 2]),
                           obsCovs = list(survey_cov = nmix_data$survey.cov))
summary(umf)
```

### Fit

```{r nmix_unmarked_fit}
fm2 <- pcount( ~ survey_cov ~ site_cov, data = umf)
print(fm2)
```


## JAGS

```{r nmix_jags, cache=TRUE}
set.seed(1)
jags_data <- list(M = nmix_data$nsites, J = nmix_data$nvisits,
                  y = nmix_data$C,
                  cov.abn = nmix_data$site.cov[, 2],
                  cov.det = nmix_data$survey.cov)
ini_fun <- function() {
  list(beta = rnorm(2, 0, 2),
       alpha = rnorm(2, 0, 2),
       n = apply(nmix_data$C, 1, max))
}
mod_nmix_jags <- jags.model("nmix.txt", data = jags_data,
                            inits = ini_fun, n.chains = 3)
update(mod_nmix_jags, 1000)
fit_nmix_jags <- coda.samples(mod_nmix_jags, n.iter = 2000,
                              variable.names = c("beta", "alpha"))
```

```{r}
summary(fit_nmix_jags)
```


## Stan

```{r nmix_stan_1, cache=TRUE}
stan_data <- list(M = nmix_data$nsites, J = nmix_data$nvisits,
                  Y = nmix_data$C,
                  Cov_abn = nmix_data$site.cov[, 2],
                  Cov_det = nmix_data$survey.cov,
                  Max_N = max(nmix_data$C) + 100)
mod_nmix_stan_1 <- cmdstan_model("nmix.stan")
fit_nmix_stan_1 <- mod_nmix_stan_1$sample(data = stan_data, seed = 1,
                                          chains = 4, parallel_chains = 4,
                                          iter_sampling = 1000,
                                          iter_warmup = 1000,
                                          refresh = 500)
```



```{r}
fit_nmix_stan_1$summary(c("beta", "alpha"))

```

## Reduce Sum

```{r nmix_stan_2, cache=TRUE}
mod_nmix_stan_2 <- cmdstan_model("nmix_rs.stan",
                                 cpp_options = list(stan_threads = TRUE))
fit_nmix_stan_2 <- mod_nmix_stan_2$sample(data = stan_data, seed = 1,
                                          chains = 4, parallel_chains = 4,
                                          threads_per_chain = 3,
                                          iter_sampling = 1000,
                                          iter_warmup = 1000,
                                          refresh = 500)
```

```{r}
fit_nmix_stan_2$summary(c("beta", "alpha"))
```

## Bivariate Poisson

```{r nmix_stan_3, cache=TRUE}
mod_nmix_stan_3 <- cmdstan_model("nmix_bp.stan")
fit_nmix_stan_3 <- mod_nmix_stan_3$sample(data = stan_data, seed = 1,
                                          chains = 4, parallel_chains = 4,
                                          iter_sampling = 1000,
                                          iter_warmup = 1000,
                                          refresh = 500)
```


```{r}
fit_nmix_stan_3$summary(c("beta", "alpha"))
```



